{
  "hash": "f53dec24dbd4b4ee51de27da848892b7",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Data manipulation with siuba\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\n   \nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n![](images/siuba_small.svg){width=\"434\"}\nsiuba (小巴) is a port of dplyr and other R libraries with seamless support for pandas and SQL\n\n## Comparison with different python dataframe package\n\n\n![](images/2.png){width=\"656\"}\n\n## Package download\n\n::: {#954d08e1 .cell execution_count=1}\n``` {.python .cell-code}\nimport sys\nprint(sys.version)\n```\n:::\n\n\n::: {#a1d1883f .cell execution_count=2}\n``` {.python .cell-code}\nimport os\nos.system('pip install pandas')\n```\n:::\n\n\n::: {#ee3566ad .cell execution_count=3}\n``` {.python .cell-code}\nimport os\n#os.system('pip install --upgrade pandas')\nos.system('pip install siuba')\n```\n:::\n\n\n## load package\n\n::: {#8631c044 .cell execution_count=4}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pylab as plt\nimport seaborn as sns\n\n\n\nfrom siuba.siu import call\nfrom siuba import _, mutate, filter, group_by, summarize,show_query\nfrom siuba import *\n\nfrom siuba.data import mtcars,penguins\n```\n:::\n\n\n::: {#afb9bdb8 .cell execution_count=5}\n``` {.python .cell-code}\nimport os\nos.system('pip show siuba')\n```\n:::\n\n\n::: {#6c0872d2 .cell execution_count=6}\n``` {.python .cell-code}\nsmall_mtcars = mtcars >> select(_.cyl, _.mpg, _.hp)>> head(5)\n```\n:::\n\n\n## select column\n\n### get column names\n\n::: {#152aa59a .cell execution_count=7}\n``` {.python .cell-code}\nlist(small_mtcars)\n```\n:::\n\n\n### select columns by name\n\n::: {#4f02cf58 .cell execution_count=8}\n``` {.python .cell-code}\nsmall_mtcars >> select(_.cyl, _.mpg)\n```\n:::\n\n\n### select columns by name match with 'p'\n\n::: {#cce40088 .cell execution_count=9}\n``` {.python .cell-code}\nsmall_mtcars >> select(_.contains(\"p\"))\n```\n:::\n\n\n### select columns by index\n\n#### select first and 3rd columns\n\n::: {#bfee5fa9 .cell execution_count=10}\n``` {.python .cell-code}\nsmall_mtcars >> select(0,2)\n```\n:::\n\n\n#### select first to 3rd columns\n\n::: {#20d6a43c .cell execution_count=11}\n``` {.python .cell-code}\nsmall_mtcars >> select(_[0:3])\n```\n:::\n\n\n## drop column\n\n::: {#80467170 .cell execution_count=12}\n``` {.python .cell-code}\nsmall_mtcars >> select(~_.cyl)\n```\n:::\n\n\n## Renaming column\n\n::: {#00cc4a36 .cell execution_count=13}\n``` {.python .cell-code}\nsmall_mtcars >> rename(new_name_mpg = _.mpg)\n```\n:::\n\n\n## Create column\n\n### Mutate\n\n::: {#1997f159 .cell execution_count=14}\n``` {.python .cell-code}\nmtcars.head()>> mutate(gear2 = _.gear+1\n                      ,gear3=if_else(_.gear > 3, \"long\", \"short\")\n                       ,qsec2=case_when({\n                                          _.qsec <= 17: \"short\",\n                                          _.qsec <= 18: \"Medium\",\n                                          True: \"long\"\n                                                     })\n                       )\n```\n:::\n\n\n### Transmute,create column and only keep this column\n\n::: {#d945a86b .cell execution_count=15}\n``` {.python .cell-code}\nmtcars.head()>> transmute(gear2 = _.gear+1)\n```\n:::\n\n\n## Filter rows\n\n::: {#5c26e3f7 .cell execution_count=16}\n``` {.python .cell-code}\nmtcars>> filter(_.gear ==4)\n```\n:::\n\n\n### Filters with AND conditions\n\n::: {#722c8352 .cell execution_count=17}\n``` {.python .cell-code}\nmtcars >> filter((_.cyl >4) & (_.gear == 5))\n```\n:::\n\n\n### Filters with OR conditions\n\n::: {#3b645460 .cell execution_count=18}\n``` {.python .cell-code}\nmtcars >> filter((_.cyl == 6) | (_.gear == 5))\n```\n:::\n\n\n### filter row with index\n\n#### first 3\n\n::: {#6afdf5d4 .cell execution_count=19}\n``` {.python .cell-code}\nsmall_mtcars>>head(3)\n```\n:::\n\n\n#### last 3\n\n::: {#d8204d4b .cell execution_count=20}\n``` {.python .cell-code}\n# not in siuba, in pandas\nsmall_mtcars.tail(3)\n```\n:::\n\n\n#### 5th rows\n\n::: {#60e28ff8 .cell execution_count=21}\n``` {.python .cell-code}\n# not in siuba, in pandas\nmtcars.iloc[[4]]\n```\n:::\n\n\n#### 1 and 5th rows\n\n::: {#86340464 .cell execution_count=22}\n``` {.python .cell-code}\n# not in siuba, in pandas\nmtcars.iloc[[0,4]]\n```\n:::\n\n\n#### 1 to 5th rows\n\n::: {#65e4249b .cell execution_count=23}\n``` {.python .cell-code}\n# not in siuba, in pandas\nmtcars.iloc[0:4]\n```\n:::\n\n\n#### get ramdon 5 rows\n\n::: {#1d7ae2b7 .cell execution_count=24}\n``` {.python .cell-code}\nmtcars.sample(5, random_state=42)\n```\n:::\n\n\n## Append\n\n\n### append by row\n\n::: {#15e4708d .cell execution_count=25}\n``` {.python .cell-code}\n# not available in siuba yet\n#from siuba import bind_rows\n```\n:::\n\n\n::: {#d5bc6f3a .cell execution_count=26}\n``` {.python .cell-code}\n# using pandas\n\n# get 1 to 4 rows\ndata1=mtcars.iloc[0:4]\n\n# get 9 rows\ndata2=mtcars.iloc[10:11]\n\ndata3=pd.concat([data1, data2], ignore_index = True,axis=0)\n\ndata3\n```\n:::\n\n\n### append by column\n\n::: {#f43bfa69 .cell execution_count=27}\n``` {.python .cell-code}\n# not available in siuba yet\n#from siuba import bind_columns\n```\n:::\n\n\n::: {#71aff645 .cell execution_count=28}\n``` {.python .cell-code}\n# using pandas\ndata1=small_mtcars>>select(_.mpg)\n\ndata2=small_mtcars>>select(_.cyl)\n\ndata3=pd.concat([data1, data2],axis=1)\n\ndata3\n```\n:::\n\n\n### Dropping NA values\n\n\n### keep NA values\n\n\n\n## group by\n\n### average,min,max,sum\n\n::: {#7790fd55 .cell execution_count=29}\n``` {.python .cell-code}\ntbl_query = (mtcars\n  >> group_by(_.cyl)\n  >> summarize(avg_hp = _.hp.mean()\n              ,min_hp=_.hp.min()\n              ,max_hp=_.hp.max()\n              ,totol_disp=_.disp.sum()\n  )\n  )\n\ntbl_query\n```\n:::\n\n\n### count record and count distinct record\n\n::: {#a08b824e .cell execution_count=30}\n``` {.python .cell-code}\nmtcars >> group_by(_.cyl)  >> summarize(n = _.shape[0])\n```\n:::\n\n\n::: {#83dd2923 .cell execution_count=31}\n``` {.python .cell-code}\nmtcars >> group_by(_.cyl)  >> summarize(n = _.hp.nunique())\n```\n:::\n\n\n## order rows\n\n::: {#ae8cfe4f .cell execution_count=32}\n``` {.python .cell-code}\nsmall_mtcars >> arrange(_.hp)\n```\n:::\n\n\n### Sort in descending order\n\n::: {#8af23605 .cell execution_count=33}\n``` {.python .cell-code}\nsmall_mtcars >> arrange(-_.hp)\n```\n:::\n\n\n### Arrange by multiple variables\n\n::: {#9319ced9 .cell execution_count=34}\n``` {.python .cell-code}\nsmall_mtcars >> arrange(_.cyl, -_.mpg)\n```\n:::\n\n\n## join\n\n::: {#6fb93a21 .cell execution_count=35}\n``` {.python .cell-code}\nlhs = pd.DataFrame({'id': [1,2,3], 'val': ['lhs.1', 'lhs.2', 'lhs.3']})\nrhs = pd.DataFrame({'id': [1,2,4], 'val': ['rhs.1', 'rhs.2', 'rhs.3']})\n```\n:::\n\n\n::: {#828212c3 .cell execution_count=36}\n``` {.python .cell-code}\nlhs\n```\n:::\n\n\n::: {#f85cd9a3 .cell execution_count=37}\n``` {.python .cell-code}\nrhs\n```\n:::\n\n\n### inner_join\n\n::: {#5a63b106 .cell execution_count=38}\n``` {.python .cell-code}\nresult=lhs >> inner_join(_, rhs, on=\"id\")\nresult\n```\n:::\n\n\n### full join\n\n::: {#a8615063 .cell execution_count=39}\n``` {.python .cell-code}\nresult=rhs >> full_join(_, lhs, on=\"id\")\nresult\n```\n:::\n\n\n### left join \n\n::: {#27d635cd .cell execution_count=40}\n``` {.python .cell-code}\nresult=lhs >> left_join(_, rhs, on=\"id\")\nresult\n```\n:::\n\n\n### anti join\n\nkeep data in left which not in right\n\n::: {#859078d0 .cell execution_count=41}\n``` {.python .cell-code}\nresult=lhs >> anti_join(_, rhs, on=\"id\")\nresult\n```\n:::\n\n\nkeep data in right which not in left\n\n::: {#705ca185 .cell execution_count=42}\n``` {.python .cell-code}\nresult=rhs >> anti_join(_, lhs, on=\"id\")\nresult\n```\n:::\n\n\n## Reshape tables\n\n::: {#92544c75 .cell execution_count=43}\n``` {.python .cell-code}\ncosts = pd.DataFrame({\n    'id': [1,2],\n    'price_x': [.1, .2],\n    'price_y': [.4, .5],\n    'price_z': [.7, .8]\n})\n\ncosts\n```\n:::\n\n\n### Gather data long(wide to long)\n\nBelow 3 method will give same result\n\n::: {#15064473 .cell execution_count=44}\n``` {.python .cell-code}\n# selecting each variable manually\ncosts >> gather('measure', 'value', _.price_x, _.price_y, _.price_z)\n```\n:::\n\n\nother way:\n\n::: {#a0920dcd .cell execution_count=45}\n``` {.python .cell-code}\n# selecting variables using a slice\ncosts >> gather('measure', 'value', _[\"price_x\":\"price_z\"])\n```\n:::\n\n\nother way:\n\n::: {#fe554a76 .cell execution_count=46}\n``` {.python .cell-code}\n# selecting by excluding id\ncosts >> gather('measure', 'value', -_.id)\n```\n:::\n\n\n### Spread data wide(long to wide)\n\n::: {#96f0620e .cell execution_count=47}\n``` {.python .cell-code}\ncosts_long= costs>> gather('measure', 'value', -_.id)\ncosts_long\n```\n:::\n\n\n::: {#50c837dc .cell execution_count=48}\n``` {.python .cell-code}\ncosts_long>> spread('measure', 'value')\n```\n:::\n\n\n## string\n\n::: {#eef30b95 .cell execution_count=49}\n``` {.python .cell-code}\ndf = pd.DataFrame({'text': ['abc', 'DDD','1243c','aeEe'], 'num': [3, 4,7,8]})\n\ndf\n```\n:::\n\n\n### upper case\n\n::: {#4421da08 .cell execution_count=50}\n``` {.python .cell-code}\ndf>> mutate(text_new=_.text.str.upper())\n```\n:::\n\n\n### lower case\n\n::: {#990e8c7f .cell execution_count=51}\n``` {.python .cell-code}\ndf>> mutate(text_new=_.text.str.lower())\n```\n:::\n\n\n### match\n\n::: {#f8b57ba5 .cell execution_count=52}\n``` {.python .cell-code}\ndf>> mutate(text_new1=if_else(_.text== \"abc\",'T','F')\n            ,text_new2=if_else(_.text.str.startswith(\"a\"),'T','F')\n            ,text_new3=if_else(_.text.str.endswith(\"c\"),'T','F')\n            ,text_new4=if_else(_.text.str.contains(\"4\"),'T','F')\n\n)\n```\n:::\n\n\n###  concatenation\n\n::: {#20e41bd9 .cell execution_count=53}\n``` {.python .cell-code}\ndf>> mutate(text_new1=_.text+' is '+_.text\n)\n```\n:::\n\n\n### replace\n\nUse .str.replace(..., regex=True) with regular expressions to replace patterns in strings.\n\nFor example, the code below uses \"p.\", where . is called a wildcard–which matches any character.\n\n::: {#5b7883bc .cell execution_count=54}\n``` {.python .cell-code}\ndf>> mutate(text_new1=_.text.str.replace(\"a.\", \"XX\", regex=True)\n)\n```\n:::\n\n\n### extract\n\nUse str.extract() with a regular expression to pull out a matching piece of text.\n\nFor example the regular expression “^(.*) ” contains the following pieces:\n\n-  a matches the literal letter “a”\n\n- .* has a . which matches anything, and * which modifies it to apply 0 or more times.\n\n::: {#ae45609d .cell execution_count=55}\n``` {.python .cell-code}\ndf>> mutate(text_new1=_.text.str.extract(\"a(.*)\")\n            ,text_new2=_.text.str.extract(\"(.*)c\")\n)\n```\n:::\n\n\n## date\n\n::: {#7181b2e0 .cell execution_count=56}\n``` {.python .cell-code}\ndf_dates = pd.DataFrame({\n    \"dates\": pd.to_datetime([\"2021-01-02\", \"2021-02-03\"]),\n    \"raw\": [\"2023-04-05 06:07:08\", \"2024-05-06 07:08:09\"],\n})\ndf_dates\n```\n:::\n\n\n::: {#f6268c03 .cell execution_count=57}\n``` {.python .cell-code}\nfrom datetime import datetime\n\ndf_date=df_dates>>mutate(month=_.dates.dt.month_name()\n                  ,date_format_raw = call(pd.to_datetime, _.raw)\n                  ,date_format_raw_year=_.date_format_raw.dt.year\n\n)\n\ndf_date\n```\n:::\n\n\n::: {#7ed6d234 .cell execution_count=58}\n``` {.python .cell-code}\ndf_date.info()\n```\n:::\n\n\n## using siuba with database\n\n### set up a sqlite database, with an mtcars table.\n\n::: {#943d790a .cell execution_count=59}\n``` {.python .cell-code}\nfrom sqlalchemy import create_engine\nfrom siuba.sql import LazyTbl\nfrom siuba import _, group_by, summarize, show_query, collect \nfrom siuba.data import mtcars\n\n# copy in to sqlite, using the pandas .to_sql() method\nengine = create_engine(\"sqlite:///:memory:\")\nmtcars.to_sql(\"mtcars\", engine, if_exists = \"replace\")\n```\n:::\n\n\n### create table\n\n::: {#bd77aef7 .cell execution_count=60}\n``` {.python .cell-code}\n# Create a lazy SQL DataFrame\ntbl_mtcars = LazyTbl(engine, \"mtcars\")\ntbl_mtcars\n```\n:::\n\n\n### create query\n\n::: {#1d01b5ab .cell execution_count=61}\n``` {.python .cell-code}\n# connect with siuba\n\ntbl_query = (tbl_mtcars\n  >> group_by(_.mpg)\n  >> summarize(avg_hp = _.hp.mean())\n  )\n\ntbl_query\n```\n:::\n\n\n### show query\n\n::: {#ab1a36e8 .cell execution_count=62}\n``` {.python .cell-code}\n tbl_query >> show_query()\n```\n:::\n\n\n### Collect to DataFrame\n\nbecause lazy expressions,the collect function is actually running the sql.\n\n::: {#434fabd8 .cell execution_count=63}\n``` {.python .cell-code}\ndata=tbl_query >> collect()\nprint(data)\n```\n:::\n\n\n## reference:\n\nhttps://siuba.org/\n\n",
    "supporting": [
      "4 siuba_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}